# 概要

## タイトル

**CPUの創り方**

### 日付



### 使用したコード

格納先のパス

## 読書メモ

- CPUってそもそも何なの？どうやって動いてるの？を、てを動かして理解することが目的

### Chap.1 はじめの一歩とその前に

- 抵抗/コンデンサ/ダイオード/ICなど、基本的な部品の説明。
  - そもそも工学系ではないので、基礎的なところから復習
  - 不明点は[こちら](https://www.youtube.com/@ICHIKEN1)のチャンネルで学習
  - 一通り必要なものは購入

### Chap.2 LED

- LEDの基本的な内容
  - 豆電球との違い -> 整流（一方向にしか流れない）、抵抗はほぼゼロ）
  - ただ電源とつなぐと過電流で壊れる。間に抵抗噛ませる。
  - 光エネルギーに変わるので、順電圧と呼ばれる電圧降下が発生する、
    - 実際の回路はこの順電圧を考慮して計算
  - arduinoから電源取ってやってみたら、ショートして壊しました。煙もくもく

### Chap.3 デジタル回路の基礎の基礎

- 汎用ICの説明。ICの中には複数の基本ゲート（NOTなど）が複数格納されるている。
  - 74シリーズてのが有名。
  - デジタル信号は電圧の大小で1/0を区別
-簡単な理論回路の説明
- 使ってない回路はHかLに固定しておかないと不具合の元
- 静電気危ないので気をつける（回路を触る前に逃がすことを頭に
- ICを使用する上での電源の取り扱い
  - ICにはVcc：５V, GND:0Vで接続して電源供給
  - スイッチングする際の電源供給に支障が出ないようにコンデンサを配置する
    - 近く ->パスコン：0.1μF 積層セラミックコンデンサ
    - 基盤に一つ -> 100μF 電解コンデンサ

### Chap.4 リセット回路とクロック回路

- スイッチのイロハ
  - プルアップ
    - 通常のトグルスイッチは切り替えるタイミングで、一瞬どこにも設置していない状態が発生する
    - このときに動作が不安定になるため、CLOCK信号を抵抗で+5Vに接続する
      - プラス側に固定  -> プルアップ
  - チャタリング
    - スイッチ切り替え時の接触を繰り返すことによって、複数回切り替えたと誤認してしまう
    - 対処法として、コンデンサを噛ませて応答遅れを発生させる
    - コンデンサ位への充電で時間稼ぎをして、チャタリングを防ぐ
    - このときの時間の目安が時定数（R×C）
  - シュミットトリガ
    - コンデンサによる応答遅れによって、電圧の変化がゆっくりになるため中途半端な電圧の時間が発生することになる
    - このときにしきい値にヒスをもたせることによって、不安定な出力にならないようにする
    - シュミットトリガを間にかませるとOK -> 74HC14を使用する

- リセット回路
  - 単にスイッチ回路の出力に追加でシュミットトリガで反転追加してるだけ。
  - 回路作成
    - IC1つ破壊。、
      - 確認大事！！
    - 1秒位スイッチを押している間だけLEDが消える
      - コンデンサの放電によるもの

- クロックジェネレータ
  - クロック周波数とかのクロックを実際に作ってみよう
  - リセット回路をループ状にするような形で、コンデンサの充放電を利用してHとLを繰り返す
  - 実際に回路図を元に作成
  - 74HC14単体で1AにHを入力すると1YからはLが出力、逆も然りを確認
  - ![TD4_clock_coounter_1Hz-ezgif com-video-to-gif-converter](https://github.com/fmoch/read_memo/assets/116940479/bd6bedd3-a3a6-4616-bbe3-c8f4d7350579)
    - 電源はarduinoを使用
    - １Hzと10Hzそれぞれ作成
    - 問題なく動作してる模様！
    - 手動クロック回路も作成
  
### Chap.5 ROMを作る

> 本書ではROMはディップスイッチで自作しているが、拡張性に乏しく、作成に時間がかかるため、Arduinoに代替する

- そもそもROMとは"ROM Read Only Memory"の略。読み込み専用という名ではあるがPCなんかはRAM。
- 語弊はあるが「プログラムを書き込む場所」のイメージ

### Chap.6 CPUの設計準備

- CPUの前に機械語に関して基礎的なところをお勉強
- C言語やBASICなどは高級言語 -> コンパイラして機械語に変換
- 今回扱うTD4（とりあえず動作する4bit CPU）は4bitで処理
  - 0000から1111で扱う
- この4bitを刻するのが「レジスタ」、レジスタに値を代入したり演算するのがCPU
  - TD4ではAとBの2つのレジスタをもつ
- TD4の命令は8bitで上位4nit、下位4bitに分かれる
  - 上位（命令）：`オペレーションコード`、下位（値）：`イミディエイトデータ（Im）`
    - Imデータが不必要な場合は0で埋める
  - 今回はイミディエイトデータはImと略す
  - AレジスタニImを転送すること MOV A, Im と表す
    - MOV等命令を表す英単語：`ニーモック`
    - MOV A,1001 `アセンブラで記載されたプログラム`
    - 実際には2進数（00111001）でこれが`機械語`
  - 命令としては`レジスタ間転送`、`加算命令`、`ジャンプ命令`、`条件付きジャンプ命令
  - 今回のTD4に置いては8bitの命令を16行（ROMを作成する場合）のプログラム
    - 上から順次実行、終了する場合は自身にジャンプるする命令で繰り返して対応
  - 加算命令では5bit以上の繰り上がりは、フラグを用いて対応
- プログラムカウンタ
  - 0番地から順に実行する際のプログラム番号をカウンタする
- I/O
  - Input
    - 入力命令はINぷと4bitをA及びBレジスタに転送
  - Output
    - OutputにはImデータまたはレジスタデータを出力できる

### Chap.7 1bitCPU（らしきもの）

- `フリップフロップ` (74HC74)
  - クロックがLからHに変化（立ち上がるとき）にデータをキャプチャする
  - 再度L->H二変化した場合は上書きされる
  - 1つに付き1bitしか記憶できないので4bitレジスタは4つのフリップフロップが必要
  - 上書きされるのを防ぐためには`自身の出力をキャプチャさせる`こと
    - 入力セレクタを用いて保持するか上書きするか選ぶ
  **！以下重要！**

  - `データの保持：フリップフロップの出力を入力に戻す`
  - `レジスタ間のデータコピー：転送元のフリップフロップの出力を、転送先のフリップフロップの入力につなぐ`
  - `演算：回路としては転送と同じ。データの転送途中に演算回路を挟む`

- `データセレクタ` (74HC153)
  - 演算と保持に関しては切り替えるためのスイッチを出力側に設置する
  - 単純な理論回路で切り替える。
    - セレクト信号Aを用いて、信号C0とC1の信号を切り替える
    - 2入力だけでなく、4入力に関しても同様にデータセレクタで出力を切り替えることができる
      - この場合セレクタ信号が2つに増える

- `レジスタの入力に２Chのデータセレクタ` (74HC161)
  - 複数のレジスタを持つ場合、MOV B, Aのとき一方は転送BはAからの出力を入力、Aは自身の出力を入力として受け取る
  - このとき「各レジスタの入力に２Chのデータセレクタ」、「全出力に対するデータセレクタ」の2つを実装すれば良い。
    - 「各レジスタの入力に２Chのデータセレクタ」はHC161によって実装可能
      - 4bit分のフリップフロップを一つのICに内蔵->一つのICで一つのレジスタを実装可能
      - 実際HC161はカウンタとして使用するものだが、入力のうち「ENP」と「ENT」をLで固定するとカウントの機能は殺せる
  - 「各レジスタの入力に２Chのデータセレクタ」×4、「全出力(4つ)に対するデータセレクタ」×1を組み合わせる。
    - 各レジスタからの4bitの出力をそれぞれ1bitずつに分けたあと、データセレクタによってレジスタに対する入力信号として何を送るかを選択する
    - 隠れ自他にはLOAD信号によって自身の信号を保持するか、上書きするかを選択する。
  
  - 制御する信号としてはレジスタに保持するか命令する「LOAD」が各レジスタに1本の系4本と、データセレクタに対するSELECT信号2本の系6本

### Chap.8 ALUとプログラムカンタ

ALU(Arithmetic and Logic Unit)
 > ALU（Arithmetic and Logic Unit）とは、コンピュータを構成する基本的な装置の一つで、算術演算（四則演算）や論理演算などの計算を行う装置。現代のコンピュータでは制御装置とともにマイクロプロセッサ（CPU/MPU）などの論理回路の一部として実装されている。

- `全加算器` (74HC283)
- ICチップとしては様々な演算が内蔵されている74HC181が有名だが、現在手に入らなくなっている
  - 代用として4bit加算機の74HC283を使用する
- 2進数1bit加算回路
  - 半加算回路：桁上りは入力に含まない
  - 全加算回路：桁上りを入力に含む
    - TD4に関しては4bitなのでこれが4つ存在する
- 演算は転送の途中に演算しているだけ
  - データセレクタのあとにALUを割り込ませる
    - Imデータを加算させるだけならこれでOK
  - `MOV A, B`の場合も加算されてしまう？？
    - その場合はImデータは「0000」にするとOK 
  - `MOV A, Im`の場合はImデータだけでいいのにレジスタの出力が加算されてしまう
    - その場合はレジスタからの出力を「0000」にすればOK
      - 今回はDレジスタを0000出力専用に変更
  - `キャリーフラグ`：加算で発生したフラグをキャリー、記録するものがキャリーフラグ
    - 全加算器にはキャリー出力がある
      - キャリーフラグ（記憶するため）としてフリップフロップ(74HC74)を使用

- `プログラムカウンタ`
  - 現在の命令の位置を指し示す役割を持つ
  - 役割としては次の2点
    - リセットでカウンタを0にする
    - クロックの立ち上がりでカウントアップする
  - 今回は(74HC161)を用いる ※元々はこっちがホントの役割
  - Dレジスタとして使用していたものをプログラムカウンタとして使用
    - 出力はROMに接続する
      - ROMはこれで指定されてた命令を出力することができる（命令フェッチが可能）
  - ジャンプ命令はプログラムカウンタにImデータを直接転送しているだけ
    - すなわちニーモックは0000
  - 同様に条件ジャンプ命令はキャリー信号をもとにプログラムカウンタを上書きするかしないかを決める

- `I/Oポート`
  - 出力ポート
    - Cレジスタの出力をLEDに接続して出力とする
  - 入力ポート
    - 本来Cレジスタの出力が接続していたCMOS信号に、ディップスイッチを取り付けて入力とする

